<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Firebase_version9_RealtimeDB(G'sACADEMY初学者用サンプル)</title>
</head>

<body>

    <!-- コンテンツ表示画面 -->

    <div>
        <div> 名前：<input type="text" id="uname"> </div>
        <div>
            <textarea id="text" cols="30" rows="10"></textarea>
            <button id="send">送信</button>
        </div>
        <div>
            <ul id='output' class='dialogue'></ul>
        </div>
    </div>
    <!--/ コンテンツ表示画面 -->


    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- JQuery -->
    
    <!-- kuromoji -->
    <script src='./kuromoji.js'></script>
    <!--/ kuromoji -->


    <!--** 以下Firebase **-->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved }     // TODO: Add SDKs for Firebase products that you want to use
            from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBmRFYJp-TjmjRilxp6v2ln0BnCvUkrMbE",
            authDomain: "chat-732f9.firebaseapp.com",
            projectId: "chat-732f9",
            storageBucket: "chat-732f9.appspot.com",
            messagingSenderId: "1099187242727",
            appId: "1:1099187242727:web:70de0784cba251b35d8442"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); // データベースへの接続
        const dbRef = ref(db, 'chat'); // どのデータベースを参照するか

        $('#send').on('click', (efg) => {
            console.log(efg);
            shapeHTML();
        });

        $("#text").on("keydown", (e) => {
            if (e.keyCode === 13) {
                shapeHTML();
            }
        });

        let shapeHTML = () => {
            const msg = {
                uname: $('#uname').val(),
                text: $('#text').val()
            }
            const newPostRef = push(dbRef); // データをユニークなものにするための記述
            set(newPostRef, msg) // データを保存
            $('#uname').val(null);
            $('#text').val('');
        };

        onChildAdded(dbRef, function (data) {
            const msg = data.val();
            const key = data.key;
            let h = `<li id='${key}' class='dialogue'>`;
            h += msg.uname;
            h += ' wrote;<br>「';
            h += msg.text;
            h += '」</li>';
            $("#output").prepend(h); //#outputの先頭に追加
        })

        onChildRemoved(dbRef, function (data) {
            // const key = data.key;
            // $(`#${key}`).slideUp(200);
            location.reload();
        })

        $('#output').on('click', function (e) {
            console.log(e);
            const thisID = e.target.id;
            const deletePostRef = $('li').attr('id');
            remove(ref(db, `chat/${thisID}`));
        })
    </script>

    <script>
        const DICT_PATH = './dict';
        const story = '昔々、あるところにおじいさんとお婆さんが住んでいたそうな。お爺さんは山へ芝刈りに、お婆さんは川へ洗濯に向かいましたとさ。すると、川上からどんぶらこどんぶらこと大きな桃が流れてきました。';
        
        window.onload = (event)=>{
            const ids = [];
            const names = [];

            // Kuromoji
            kuromoji.builder({dicPath: DICT_PATH}).build((err, tokenizer)=>{
                // const tokens = tokenizer.tokenize(story);// 解析データの取得
                // tokens.forEach((token)=>{
                //     console.log(token);
                // });
            })
        }
    </script>


</body>

</html>